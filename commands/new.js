const path = require('path');
const { getUserInputs2 } = require('../utils/userInput');
const { createProject } = require('../utils/setups/projectSetup');
const { setupCleanArchitecture } = require('../utils/configs/setupCleanArchitecture');
const { setupAuth } = require('../utils/setups/setupAuth');
const { setupSwagger } = require('../utils/setups/setupSwagger');
const { setupDatabase } = require('../utils/setups/setupDatabase');
const { configureDocker } = require('../utils/configs/configureDocker');
const { setupBootstrapLogger } = require('../utils/setups/setupLogger');
const { logSuccess } = require('../utils/loggers/logSuccess');
const { logInfo } = require('../utils/loggers/logInfo');
const readline = require('readline-sync');

async function newCommand(projectName, flags = {}) {
  let inputs;

  if (flags.light && projectName) {
    console.log('ğŸš€ Mode Light activÃ© - Configuration rapide');

    const orm = flags.orm || 'prisma';
    const validOrms = ['prisma', 'typeorm', 'mongoose'];

    if (!validOrms.includes(orm)) {
      console.log(`âš ï¸  ORM non reconnu: ${orm}. Utilisation de Prisma par dÃ©faut.`);
    }

    inputs = {
      projectName: projectName,
      useYarn: false,
      useDocker: true,
      useAuth: flags.auth || false,
      useSwagger: flags.swagger || false,
      swaggerInputs: flags.swagger ? {
        title: `${projectName} API`,
        description: 'API generated by NestCraftX',
        version: '1.0.0',
        endpoint: 'api/docs'
      } : undefined,
      packageManager: 'npm',
      entitiesData: {
        entities: [],
        relations: []
      },
      selectedDB: orm === 'mongoose' ? 'mongodb' : 'postgresql',
      dbConfig: orm === 'mongoose' ? {
        orm: 'mongoose',
        MONGO_URI: 'mongodb://localhost:27017',
        MONGO_DB: projectName
      } : {
        orm: validOrms.includes(orm) ? orm : 'prisma',
        POSTGRES_USER: 'postgres',
        POSTGRES_PASSWORD: 'postgres',
        POSTGRES_DB: projectName,
        POSTGRES_HOST: 'localhost',
        POSTGRES_PORT: '5432'
      }
    };

    if (flags.auth) {
      console.log('ğŸ” Auth activÃ© : ajout automatique de l\'entitÃ© User');
      inputs.entitiesData.entities.push({
        name: 'user',
        fields: [
          { name: 'email', type: 'string' },
          { name: 'password', type: 'string' },
          { name: 'isActive', type: 'boolean' }
        ]
      });
    }

  } else if (projectName) {
    console.log('ğŸš€ Mode Full - Configuration complÃ¨te');
    console.log(`ğŸ“¦ Nom du projet: ${projectName}\n`);

    inputs = await getUserInputs2();
    inputs.projectName = projectName;

    if (flags.orm) {
      const validOrms = ['prisma', 'typeorm', 'mongoose'];
      if (validOrms.includes(flags.orm)) {
        inputs.dbConfig.orm = flags.orm;
        logInfo(`ORM forcÃ© via CLI: ${flags.orm}`);
      }
    }

    if (flags.auth !== undefined) {
      inputs.useAuth = flags.auth === true || flags.auth === 'true';
    }

    if (flags.swagger !== undefined) {
      inputs.useSwagger = flags.swagger === true || flags.swagger === 'true';
    }

  } else {
    console.log('\nğŸŒŸ Bienvenue sur NestCraftX CLI ğŸŒŸ\n');
    inputs = await getUserInputs2();
  }

  logInfo('ğŸ—ï¸  DÃ©marrage de la gÃ©nÃ©ration du projet...');

  await createProject(inputs);
  await setupCleanArchitecture(inputs);

  if (inputs.useAuth) await setupAuth(inputs);

  if (inputs.useSwagger) {
    await setupSwagger(inputs.swaggerInputs);
  } else {
    setupBootstrapLogger();
  }

  if (inputs.useDocker) await configureDocker(inputs);

  await setupDatabase(inputs);

  console.log('\n' + '='.repeat(60));
  logSuccess(`âœ¨ Projet ${inputs.projectName} crÃ©Ã© avec succÃ¨s!`);
  console.log('='.repeat(60));

  console.log('\nğŸ“Š RÃ©sumÃ© de la configuration:');
  console.log(`   ğŸ“ Projet: ${inputs.projectName}`);
  console.log(`   ğŸ—„ï¸  Base de donnÃ©es: ${inputs.selectedDB}`);
  console.log(`   ğŸ”§ ORM: ${inputs.dbConfig.orm}`);
  console.log(`   ğŸ” Auth: ${inputs.useAuth ? 'Oui' : 'Non'}`);
  console.log(`   ğŸ“š Swagger: ${inputs.useSwagger ? 'Oui' : 'Non'}`);
  console.log(`   ğŸ³ Docker: ${inputs.useDocker ? 'Oui' : 'Non'}`);
  console.log(`   ğŸ“¦ EntitÃ©s: ${inputs.entitiesData.entities.length}`);

  console.log('\nğŸš€ Prochaines Ã©tapes:');
  console.log(`   1. cd ${inputs.projectName}`);
  console.log(`   2. ${inputs.packageManager} run start:dev`);

  if (inputs.useSwagger) {
    console.log(`   3. Ouvrir http://localhost:3000/${inputs.swaggerInputs.endpoint}`);
  }

  console.log('\nğŸ’¡ Commandes utiles:');
  console.log('   - nestcraftx test      VÃ©rifier l\'environnement');
  console.log('   - nestcraftx info      Informations sur le CLI');
  console.log('   - nestcraftx --help    Aide complÃ¨te\n');
}

module.exports = newCommand;
