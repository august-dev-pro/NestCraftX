const { getFullModeInputs } = require("../utils/fullModeInput");
const { getLightModeInputs } = require("../utils/lightModeInput");
const { createProject } = require("../utils/setups/projectSetup");
const {
  setupCleanArchitecture,
} = require("../utils/configs/setupCleanArchitecture");
const {
  setupLightArchitecture,
} = require("../utils/configs/setupLightArchitecture");
const { setupAuth } = require("../utils/setups/setupAuth");
const { setupSwagger } = require("../utils/setups/setupSwagger");
const { setupDatabase } = require("../utils/setups/setupDatabase");
const { configureDocker } = require("../utils/configs/configureDocker");
const { setupBootstrapLogger } = require("../utils/setups/setupLogger");
const { logSuccess } = require("../utils/loggers/logSuccess");
const { logInfo } = require("../utils/loggers/logInfo");
const { logError } = require("../utils/loggers/logError");
const { generateEnvFile, writeEnvFile } = require("../utils/envGenerator");

async function newCommand(projectName, flags = {}) {
  if (!projectName) {
    console.log("\n  Bienvenue sur NestCraftX CLI  \n");
    const inputs = await getFullModeInputs();
    return executeProjectSetup(inputs);
  }

  const mode = determineMode(flags);
  const inputs =
    mode === "light"
      ? await buildLightModeInputs(projectName, flags)
      : await buildFullModeInputs(projectName, flags);

  return executeProjectSetup(inputs);
}

function determineMode(flags) {
  if (flags.light) return "light";
  if (flags.full) return "full";
  if (flags.mode) return flags.mode;
  return "full";
}

async function buildLightModeInputs(projectName, flags) {
  const hasAllRequiredFlags = hasAllLightModeFlags(flags);

  if (hasAllRequiredFlags) {
    console.log("  Mode LIGHT - Configuration rapide (via flags)\n");
    return buildLightModeFromFlags(projectName, flags);
  }

  return getLightModeInputs(projectName, flags);
}

async function buildFullModeInputs(projectName, flags) {
  // 1. Tente de construire les inputs avec les flags si l'ORM est fourni (mode non-interactif)
  if (hasAllFullModeFlags(flags)) {
    console.log(" Â Mode FULL - Configuration rapide (via flags)\n");
    return buildFullModeFromFlags(projectName, flags);
  }

  // 2. Sinon, utiliser la fonction interactive
  const inputs = await getFullModeInputs(projectName, flags);
  // Les fonctions interactives retournent dÃ©jÃ  l'objet complet,
  // mais on peut s'assurer que projectName et mode sont corrects.
  inputs.projectName = projectName;
  inputs.mode = "full";

  return inputs;
}

function hasAllLightModeFlags(flags) {
  return flags.orm !== undefined;
}

function buildLightModeFromFlags(projectName, flags) {
  const orm = flags.orm || "prisma";
  const validOrms = ["prisma", "typeorm", "mongoose"];

  if (!validOrms.includes(orm)) {
    logError(`ORM non reconnu: ${orm}. Utilisation de Prisma par defaut.`);
  }

  const inputs = {
    projectName,
    mode: "light",
    useYarn: false,
    useDocker: flags.docker !== false,
    useAuth: !!flags.auth,
    useSwagger: !!flags.swagger,
    swaggerInputs: flags.swagger
      ? {
          title: `${projectName} API`,
          description: "API generated by NestCraftX",
          version: "1.0.0",
          endpoint: "api/docs",
        }
      : undefined,
    packageManager: "npm",
    entitiesData: {
      entities: [],
      relations: [],
    },
    selectedDB: orm === "mongoose" ? "mongodb" : "postgresql",
    dbConfig:
      orm === "mongoose"
        ? {
            orm: "mongoose",
            MONGO_URI: "mongodb://localhost:27017",
            MONGO_DB: projectName,
          }
        : {
            orm: validOrms.includes(orm) ? orm : "prisma",
            POSTGRES_USER: "postgres",
            POSTGRES_PASSWORD: "postgres",
            POSTGRES_DB: projectName,
            POSTGRES_HOST: "localhost",
            POSTGRES_PORT: "5432",
          },
  };

  if (flags.auth) {
    logInfo("Auth active : ajout automatique de l'entite User");
    inputs.entitiesData.entities.push({
      name: "user",
      fields: [
        { name: "email", type: "string" },
        { name: "password", type: "string" },
        { name: "isActive", type: "boolean" },
      ],
    });
  }

  return inputs;
}

function hasAllFullModeFlags(flags) {
  // Si l'utilisateur a fourni --interactive, on FORCE le mode interactif (return false)
  if (flags.interactive === true) {
    return false;
  }

  // Sinon, on vÃ©rifie si l'ORM est prÃ©sent pour basculer en mode rapide/silencieux
  return flags.orm !== undefined;
}

function buildFullModeFromFlags(projectName, flags) {
  const orm = flags.orm || "prisma";
  const validOrms = ["prisma", "typeorm", "mongoose"];
  const finalOrm = validOrms.includes(orm) ? orm : "prisma";

  // DÃ©termination du gestionnaire de paquets
  const packageManager = flags.yarn ? "yarn" : "npm";

  // Configuration de la DB par dÃ©faut (similaire Ã  light, mais avec plus de flags optionnels)
  const defaultDBConfig =
    finalOrm === "mongoose"
      ? {
          orm: finalOrm,
          MONGO_URI: flags.mongoUri || "mongodb://localhost:27017",
          MONGO_DB: flags.dbName || projectName,
        }
      : {
          orm: finalOrm,
          POSTGRES_USER: flags.dbUser || "postgres",
          POSTGRES_PASSWORD: flags.dbPassword || "postgres",
          POSTGRES_DB: flags.dbName || projectName,
          POSTGRES_HOST: flags.dbHost || "localhost",
          POSTGRES_PORT: flags.dbPort || "5432",
        };

  const useAuth = flags.auth !== false;
  const useSwagger = flags.swagger !== false;
  const useDocker = flags.docker !== false;

  const inputs = {
    projectName,
    mode: "full",
    useYarn: flags.yarn === true,
    packageManager: packageManager,
    useDocker: useDocker,
    useAuth: useAuth,
    useSwagger: useSwagger,
    swaggerInputs: useSwagger
      ? {
          title: flags.swaggerTitle || `${projectName} API`,
          description: flags.swaggerDesc || "API generated by NestCraftX",
          version: flags.swaggerVersion || "1.0.0",
          endpoint: flags.swaggerEndpoint || "api/docs",
        }
      : undefined,
    entitiesData: {
      entities: [],
      relations: [],
    },
    selectedDB: finalOrm === "mongoose" ? "mongodb" : "postgresql",
    dbConfig: defaultDBConfig,
  };

  if (useAuth) {
    // Si l'authentification est active, l'entitÃ© User est ajoutÃ©e par dÃ©faut
    inputs.entitiesData.entities.push({
      name: "user",
      fields: [
        { name: "email", type: "string" },
        { name: "password", type: "string" },
        { name: "isActive", type: "boolean" },
      ],
    });
  }

  // Dans ce mode rapide, on ignore la crÃ©ation d'entitÃ©s et de relations complexes par flags.

  return inputs;
}

async function buildFullModeInputs(projectName, flags) {
  // 1. VÃ‰RIFICATION : Si suffisamment de flags sont fournis (ex: --orm est prÃ©sent)
  if (hasAllFullModeFlags(flags)) {
    return buildFullModeFromFlags(projectName, flags);
  }

  // 2. ALTERNATIVE : Sinon, lancer le mode interactif (Par dÃ©faut)
  const inputs = await getFullModeInputs(projectName, flags);

  return inputs;
}

async function executeProjectSetup(inputs) {
  try {
    logInfo("Demarrage de la generation du projet...");

    await createProject(inputs);

    if (inputs.mode === "light") {
      await setupLightArchitecture(inputs);
    } else {
      await setupCleanArchitecture(inputs);
    }

    if (inputs.useAuth) await setupAuth(inputs);

    if (inputs.useSwagger) {
      await setupSwagger(inputs.swaggerInputs);
    } else {
      setupBootstrapLogger();
    }

    if (inputs.useDocker) await configureDocker(inputs);

    await setupDatabase(inputs);

    const envContent = await generateEnvFile(inputs);
    writeEnvFile(envContent);

    printSuccessSummary(inputs);
  } catch (error) {
    logError(`Erreur lors de la creation du projet: ${error.message}`);
    throw error;
  }
}

function printSuccessSummary(inputs) {
  console.log("\n" + "=".repeat(60));
  logSuccess(`Projet ${inputs.projectName} cree avec succes!`);
  console.log("=".repeat(60));

  console.log("\nResume de la configuration:");
  console.log(` Â  Projet: ${inputs.projectName}`);
  console.log(` Â  Mode: ${inputs.mode || "full"}`.toUpperCase());
  console.log(` Â  Base de donnees: ${inputs.selectedDB}`);
  console.log(` Â  ORM: ${inputs.dbConfig.orm}`);
  console.log(` Â  Auth: ${inputs.useAuth ? "Oui" : "Non"}`);
  console.log(` Â  Swagger: ${inputs.useSwagger ? "Oui" : "Non"}`);
  console.log(` Â  Docker: ${inputs.useDocker ? "Oui" : "Non"}`);
  console.log(` Â  Entites: ${inputs.entitiesData.entities.length}`);

  console.log("\nðŸš€ Prochaines Ã©tapes:");
  console.log(` Â  1. cd ${inputs.projectName}`);

  // --- INSTRUCTIONS SPÃ‰CIFIQUES Ã€ L'ORM/DB ---

  if (inputs.dbConfig.orm === "prisma" || inputs.dbConfig.orm === "typeorm") {
    // Instructions pour PostgreSQL (Prisma et TypeORM)
    console.log("\n Â  2. CrÃ©ez une base de donnÃ©es PostgreSQL vide.");
    console.log(" Â     (Ex: `createdb " + inputs.dbConfig.POSTGRES_DB + "`)");
    console.log(
      " Â  3. Modifiez le fichier .env avec vos informations de connexion."
    );

    if (inputs.dbConfig.orm === "prisma") {
      console.log("\n Â  4. **Migrations & Seed (Prisma) :**");
      console.log(`        ${inputs.packageManager} prisma migrate reset`);
      console.log(`          ${inputs.packageManager} prisma migrate dev`);
    } else {
      // TypeORM
      console.log("\n Â  4. **Migrations (TypeORM) :**");
      console.log(` Â  Â  Â - ${inputs.packageManager} run typeorm:migration:run`);
      // console.log(` Â  Â  Â - ${inputs.packageManager} run typeorm:seed`); // Si un script seed est fourni
    }
    console.log("\n Â  5. Lancez le projet:");
    console.log(` Â  Â  Â - ${inputs.packageManager} run start:dev`);
  } else if (inputs.dbConfig.orm === "mongoose") {
    // Instructions pour MongoDB (Mongoose)
    console.log("\n Â  2. Assurez-vous que votre serveur MongoDB est dÃ©marrÃ©.");
    console.log(" Â  3. Modifiez le fichier .env (variable MONGO_URI).");
    console.log(" Â     (La base de donnÃ©es sera crÃ©Ã©e automatiquement)");

    console.log("\n Â  4. Lancez le projet:");
    console.log(` Â  Â  Â - ${inputs.packageManager} run start:dev`);
    /*  console.log(
      ` Â  5. ExÃ©cutez le script de seed (si disponible): ${inputs.packageManager} run seed`
    ); */
  }

  // --- ENDPOINTS / SWAGGER ---

  if (inputs.useSwagger) {
    console.log(
      ` Â  6. Ouvrir Swagger UI : http://localhost:3000/${inputs.swaggerInputs.endpoint}`
    );
  }

  console.log("\nCommandes utiles:");
  console.log(" Â  - nestcraftx test Â  Â  Â Verifier l'environnement");
  console.log(" Â  - nestcraftx info Â  Â  Â Informations sur le CLI");
  console.log(" Â  - nestcraftx --help Â  Â Aide complete\n");
}

module.exports = newCommand;
